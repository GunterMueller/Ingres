#!/bin/bash
#
#  Copyright (c) 1992, 2004 Ingres Corporation
#
#  Name:
#	iisuc2 -- set up C2 security auditing package 
#
#  Usage:
#	iisuc2
#
#  Description:
#	This script should only be called by the Ingres installation
#	utility.  It sets up the C2 auditing option.
#
#  Exit Status:
#	0	setup procedure completed.
#	1	setup procedure did not complete.
#
#  DEST = utility
#----------------------------------------------------------------------------

if [ "$1" = "-rmpkg" ] ; then
   cat << !
  Ingres C2 Security Auditing has been removed

!
exit 0
fi

WRITE_RESPONSE=false
READ_RESPONSE=false
RESOUTFILE=ingrsp.rsp
RESINFILE=ingrsp.rsp
RPM=false
BATCH=false
INSTLOG="2>&1 | tee -a $II_SYSTEM/ingres/files/install.log"

# check for batch flag 
BATCH=false
INSTLOG="2>&1 | tee -a $II_SYSTEM/ingres/files/install.log"
 
while [ $# != 0 ]
do
    case "$1" in
        -batch)
            BATCH=true ; export BATCH ; 
	    INSTLOG="2>&1 | cat >> $II_SYSTEM/ingres/files/install.log"
	    export INSTLOG;
            shift ;;
	-vbatch)
	    BATCH=true ; export BATCH ;
            export INSTLOG;
            shift ;;
        -mkresponse)
            WRITE_RESPONSE=true ; export WRITE_RESPONSE ;
            if [ "$2" ] ; then
                RESOUTFILE=$2
		shift;
            fi
            export RESOUTFILE;
            export INSTLOG;
            shift ;;
        -exresponse)
            READ_RESPONSE=true ; export READ_RESPONSE ;
	    BATCH=true ; export BATCH ;
            if [ "$2" ] ; then
                RESINFILE=$2
		shift;
            fi
            export RESINFILE;
            export INSTLOG;
            shift ;;
        -rpm)
            BATCH=true ; export BATCH ; 
	    RPM=true
	    INSTLOG="2>&1 | cat >> $II_SYSTEM/ingres/files/install.log"
	    export INSTLOG;
            shift ;;
        *)
            echo "ERROR: Unknown option to iisuc2: $1" ;
            echo "usage: iisuc2 [ -batch ] [ -vbatch ] [ -mkresponse] \
[ -exresponse] [ response file]"
            exit 1 ;;
    esac
done

if [ "$WRITE_RESPONSE" = "false" ] ; then
trap "rm $II_CONFIG/config.lck 1>/dev/null 2>/dev/null; exit 1" 1 2 15
fi

do_iisuc2()
{
echo "Setting up Ingres C2 Security Auditing..."
if [ "$WRITE_RESPONSE" = "false" ] ; then
trap "rm $II_CONFIG/config.lck 1>/dev/null 2>/dev/null; exit 1" 1 2 15
fi

. iisysdep

. iishlib

check_response_file # check if the response files do exist.

if [ "$WRITE_RESPONSE" = "true" ] ; then
        mkresponse_msg
else

# override value of II_CONFIG set by ingbuild 
II_CONFIG=$II_SYSTEM/ingres/files
export II_CONFIG

iisulock "Ingres C2 Security Auditing setup" || exit 1

# create symbol.tbl in $II_SYSTEM/ingres/files if not found
[ -f $II_SYSTEM/ingres/files/symbol.tbl ] ||
{
   touch $II_SYSTEM/ingres/files/symbol.tbl ||
   {
      cat << !

Unable to create $II_SYSTEM/ingres/files/symbol.tbl.  Exiting...

!
      rm $II_CONFIG/config.lck
      exit 1
   }
}

# create config.dat if it doesn't exist
[ -f $II_CONFIG/config.dat ] ||
{
   touch $II_CONFIG/config.dat 2>/dev/null ||
   {
      cat << !

Unable to create $II_CONFIG/config.dat.  Exiting...

!
      rm $II_CONFIG/config.lck
      exit 1
   }
   chmod 644 $II_CONFIG/config.dat
}

SERVER_HOST=`iigetres ii."*".config.server_host`

if [ -n "$SERVER_HOST" -a "$SERVER_HOST" != "$CONFIG_HOST" ] ; then
   CLUSTER_ID=""
   if $CLUSTERSUPPORT ; then
      CLUSTER_ID="`iigetres \
	    ii.$CONFIG_HOST.config.cluster.id`"
      case "$CLUSTER_ID" in
      [1-9]|[12][0-9]|3[0-2])     # Setup for cluster
	  ;;
      *)          # normal non-server setup.
	  CLUSTER_ID=""
	  ;;
      esac
   fi
   [ -z "$CLUSTER_ID" ] &&
   {
      cat << !

   This is an Ingres client installation.

   Ingres C2 Security Auditing can only be set up for server installations.

!
      rm $II_CONFIG/config.lck
      exit 1
   } 
fi

if [ -f $II_SYSTEM/ingres/install/release.dat ]; then
    VERSION=`$II_SYSTEM/ingres/install/ingbuild -version=dbms` ||
    {
   # display output of failed ingbuild call
   cat << !

$VERSION

!
      rm $II_CONFIG/config.lck
      exit 1
   }
else
   VERSION=`head -1 $II_SYSTEM/ingres/version.rel` ||
   {
       cat << !

Missing file $II_SYSTEM/ingres/version.rel

!
      rm $II_CONFIG/config.lck
      exit 1
   }
fi

RELEASE_ID=`echo $VERSION | sed "s/[ ().\/]//g"`

SETUP=`iigetres ii.$CONFIG_HOST.config.c2.$RELEASE_ID` ||
{
   rm $II_CONFIG/config.lck
   exit 1
}

[ "$SETUP" = "complete" ] &&
{
   cat << !

Ingres C2 Security Auditing has already been set up on "$HOSTNAME".

!
   rm $II_CONFIG/config.lck
   $BATCH || pause
   exit 0
}

SERVER_SETUP=`iigetres ii.$CONFIG_HOST.config.dbms.$RELEASE_ID`

[ "$SERVER_SETUP" != "complete" ] &&
{
   cat << !

The setup procedure for the following version of the Ingres
Intelligent DBMS:

	$VERSION

must be completed up before security auditing can be set up on
this host:

	$HOSTNAME

!
   rm $II_CONFIG/config.lck
   exit 1
} 

cat << ! 

This procedure will set up Ingres Security Auditing for local host:

	$HOSTNAME

Generating default security auditing configuration...
!

# check for older values
CA_HIGH=`iigetres ii.$CONFIG_HOST.secure.ca_high`
INGRES_HIGH=`iigetres ii.$CONFIG_HOST.secure.ingres_high`
CA_LOW=`iigetres ii.$CONFIG_HOST.secure.ca_low`
INGRES_LOW=`iigetres ii.$CONFIG_HOST.secure.ingres_low`
AUDIT_MECH=`iigetres ii."*".c2.audit_mechanism`

if [ "$AUDIT_MECH" = "CA" ]
then
    iisetres ii."*".c2.audit_mechanism INGRES
fi
if [ -z "$CA_LOW" -a ! -z "$INGRES_LOW" ]
then
    iisetres ii.$CONFIG_HOST.secure.ca_low "$INGRES_LOW"
    iiremres ii.$CONFIG_HOST.secure.ingres_low
fi
if [ -z "$CA_HIGH" -a ! -z "$INGRES_HIGH" ]
then
    iisetres ii.$CONFIG_HOST.secure.ca_high "$INGRES_HIGH"
    iiremres ii.$CONFIG_HOST.secure.ingres_high
fi

iigenres $CONFIG_HOST $II_SYSTEM/ingres/files/secure.rfm || 
{
   cat << !
An error occurred while generating the default configuration.

!
   rm $II_CONFIG/config.lck
   exit 1
}

#
# Audit log prompts go here.  Use iisetres to add values to config.dat.
#

cat << !

Ingres C2 Security Auditing is now set up. 

!
rm $II_CONFIG/config.lck
iisetres ii.$CONFIG_HOST.config.c2.$RELEASE_ID complete

fi #end $WRITE_RESPONSE 

   $BATCH || pause
exit 0
}
eval do_iisuc2 $INSTLOG
trap : 0
exit 0
