#!/bin/bash
#  Copyright (c) 2004 Ingres Corporation	
#  Name: iisyslim	
#
#  Usage:
#	iisyslim -used_segs | -used_sems | -used_sets | -total_swap | 
#		-free_swap  [ outfile ]
#
#  Description:
#	Called by syscheck to get various measures of system resources
#	which are only available only in the form of textual output from
#	system commands.
#
#  Exit Status:
#	0	ok
#	1	unable to read /dev/kmem or bad argument.
#
#  PROGRAM = iisyslim
#
#  DEST = utility
#--------------------------------------------------------------------------

LibTest_in_iisysdep=false
. iisysdep

if [ "$READ_KMEM" = true -a  ! -r /dev/kmem ]
then
   cat << !

 -----------------------------------------------------------------------
|			    ***WARNING***				|
|									|
|  /dev/kmem is not readable by $WHOAMI.
|									|
|  $WHOAMI must have read permission on /dev/kmem in order to check
|  system resources.  To change permissions on /dev/kmem, you must be	|
|  logged on as root.							|
|                                                                       |
 -----------------------------------------------------------------------

!
   exit 1
fi

case "$1" in

   -used_segs)
	case $VERS in
	    *_lnx|int_rpl)
	   	USED_SEGS=`$IPCSCMD2 -m | grep "^0x" | wc -l`
		;;
	        *)
		USED_SEGS=`$IPCSCMD2 -m | grep "^0x" | wc -l`
		;;
	esac
	USED_SEGS=`expr $USED_SEGS \+ 0`
	RESULT=$USED_SEGS
      ;;

   -used_sems)
	case $VERS in
	    *_lnx|int_rpl)
		USED_SEMS=`$IPCSCMD2 -s | grep "^0x" | $AWK '{s += $5} END {print s}'`
		;;
	        *)
      		USED_SEMS=`$IPCSCMD2 -b -s | grep "^s" | $AWK '{s += $7} END {print s}'`
		;;
	esac
	if [ -z "$USED_SEMS" ]
	then
	    USED_SEMS=0
	fi
	RESULT=$USED_SEMS
      ;;

   -used_sets)
	case $VERS in
	    *_lnx|int_rpl)
		USED_SETS=`$IPCSCMD2 -s | grep "^0x" | wc -l`
		;;
	        *)
		USED_SETS=`$IPCSCMD2 -b -s | grep "^s" | wc -l`
		;;
	esac
	USED_SETS=`expr $USED_SETS \+ 0`
	RESULT=$USED_SETS
      ;;

   -total_swap)
      if $CHECK_SWAP_SPACE
      then
         STRIPJUNK="sed 's/[^0-9]//'"
         if [ "$PSTAT_TOTAL_ARG" != "" ]
         then
            TOTAL_SWAP=`eval "$PSTAT | $AWK '{ print \\\$$PSTAT_TOTAL_ARG }' \
               | $STRIPJUNK"`
            TOTAL_SWAP=`expr $TOTAL_SWAP \* $PSTAT_KBYTE_FACTOR`
         else
            FREE_SWAP=`eval "$PSTAT | $AWK '{ print \\\$$PSTAT_REMAIN_ARG }' \
               | $STRIPJUNK"`
            FREE_SWAP=`expr $FREE_SWAP \* $PSTAT_KBYTE_FACTOR`
            USED_SWAP=`eval "$PSTAT | $AWK '{ print \\\$$PSTAT_USED_ARG }' \
               | $STRIPJUNK"`
            USED_SWAP=`expr $USED_SWAP \* $PSTAT_KBYTE_FACTOR`
            TOTAL_SWAP=`expr $USED_SWAP + $FREE_SWAP`
         fi
         RESULT=$TOTAL_SWAP
      else
         RESULT=-1
      fi
      ;;

   -free_swap)
      if $CHECK_SWAP_SPACE
      then :
         STRIPJUNK="sed 's/[^0-9]//'"
         FREE_SWAP=`eval "$PSTAT | $AWK '{ print \\\$$PSTAT_REMAIN_ARG }' \
            | $STRIPJUNK"`
         FREE_SWAP=`expr $FREE_SWAP \* $PSTAT_KBYTE_FACTOR`
         RESULT=$FREE_SWAP
      else
         RESULT=-1
      fi
      ;;
   
   -*)
      echo "iisyslim: unrecognized argument: $1"
      exit 1
      ;;
esac
   
# send output to outfile if passed
if [ "$2" ]
then
   echo $RESULT > $2
else
   echo $RESULT
fi

exit 0

