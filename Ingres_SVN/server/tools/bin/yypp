#!/bin/bash
#
# Copyright (c) 2004 Ingres Corporation
#
# yypp.sh - Prepend $ING_SRC/tools/port$noise/conf/{VERS,CONFIG} to $1 and run
#           through yapp.
#
#

CMD="`basename $0`"

usage='[ -c <config> ] [ <files>... ] [ -s <sym> ] [ -D<def> ] [ -U<undef> ]'

[ -n "$ING_VERS" ] && { noise="/$ING_VERS/src" ; vers="/$ING_VERS" ; }

[ -r $ING_SRC/tools/port$noise/conf/CONFIG ] || exit 1

#Make sure we have yapp available to us
yapp </dev/null || exit 1

while [ $# -gt 0 ]
do
  case "$1" in
    -c*) if [ -z "$conf" -a `expr $1 : '.*'` -gt 2 ] ; then
           conf="`expr $1 : '-c\(.*\)'`" ; shift
         else
           [ -z "$conf" -a $# -gt 1 ] ||
           { echo "Usage:" ; echo "$CMD $usage" ; exit 1 ; }
           conf="$2" ; shift ; shift
         fi
         ;;
    -s*) if [ -z "$sym" -a `expr $1 : '.*'` -gt 2 ] ; then
           sym="`expr $1 : '-s\(.*\)'`" ; shift
         else
           [ -z "$sym" -o $# -gt 1 ] ||
           { echo "Usage:" ; echo "$CMD $usage" ; exit 1 ; }
           sym="$2" ; shift ; shift
         fi
         ;;
    -D*) [ `expr $1 : '.*'` -eq 2 ] &&
         { echo "Usage:" ; echo "$CMD $usage" ; exit 1 ; }
         defs="$defs $1" ; shift
         ;;
    -H*) [ `expr $1 : '.*'` -eq 2 ] &&
         { echo "Usage:" ; echo "$CMD $usage" ; exit 1 ; }
         hist="$hist $1" ; shift
         ;;
    -U*) [ `expr $1 : '.*'` -eq 2 ] &&
         { echo "Usage:" ; echo "$CMD $usage" ; exit 1 ; }
         undefs="$undefs $1" ; shift
         ;;
     -*) echo "Usage:" ; echo "$CMD $usage"
         exit 1
         ;;
      *) files="$files $1" ; shift
         ;;
  esac
done


if [ -x $ING_SRC/bin/readvers ] ; then
   READVERS=$ING_SRC/bin/readvers
elif [ -r $ING_SRC/tools/port$noise/shell_unix/readvers.sh ] ; then
   READVERS=$ING_SRC/tools/port$noise/shell_unix/readvers.sh
fi

. $READVERS

[ "$conf_ADD_ON32" ] && config=$config64

if [ -z "$conf" -a -z "$config" ] ; then
   echo "ERROR: Config string not given and could not execute readvers."
   echo "Usage:" ; echo " $CMD $usage" ; exit 1
# Since readvers wasn't used, check the config string 
elif [ -z "$READVERS" ] ; then
  case $conf in
    [a-z0-9][a-z0-9][a-z0-9]_us5) ;;
    [a-z0-9][a-z0-9][a-z0-9]_u42) ;;
    [a-z0-9][a-z0-9][a-z0-9]_osf) ;;
       [a-z][a-z0-9][a-z0-9]_bos) ;;
       [a-z][a-z0-9][a-z0-9]_vme) ;;
                         sqs_ptx) ;;
                           *_kit) ;;
                               *) echo "$CMD: Bad config string: $conf"
                                  echo "Usage:" ; echo " $CMD $usage"
                                  ;;
  esac
# If $conf was passed, but readvers reported a different string in
# VERS, don't use anything from readvers; it doesn't apply to $conf.
# Print a warning.
elif [ -n "$conf" -a "$conf" != "$config" ] ; then
  optdef="" ; opts=""
  echo "Warning: $config defined in VERS but $conf will be used." >&2
# Just use config and everything we got from readvers.
else
  conf=$config
fi

# Build up arguments to yapp
dconf="-D$conf"
dvers="-DVERS=$conf"
dopts="$optdef"

if [ "$sym" ] ; then
  res=`echo $sym | cat $ING_SRC/tools/port$noise/conf/CONFIG - |
       yapp $dvers $dconf $dopts $defs $hist $undefs | sed -e '/^[ 	]*$/d'`
  if [ "$res" = "$sym" ] ; then
    echo "$sym undefined in CONFIG or VERS for $conf" >&2; exit 1
  else
    echo $res
  fi
else
  cat $ING_SRC/tools/port$noise/conf/CONFIG ${files-"-"} |
      yapp $dvers $dconf $dopts $defs $hist $undefs | sed -e '/^[ 	]*$/d'
fi

exit 0
