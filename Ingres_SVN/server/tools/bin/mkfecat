#!/bin/bash
#
# Copyright (c) 2004 Ingres Corporation
#
# mkfecat - Create the file fe.cat.msg.
#
# This file is the concatenation of all the *.msg files from the
# "front" and "gateway" directories of a source tree.
#
#

: {$ING_SRC?"must be set"}

CMD=`basename $0`

[ -n "$ING_VERS" ] && V="$ING_VERS"

catfile=$ING_SRC/common/hdr/$V/hdr/fe.cat.msg

# Find the front-end and gateway .msg files, sort and unique them

if [ -d "$ING_SRC/gateway" ] ; then
    if [ -n "$ING_VERS" ] ; then
	gwdirs=`echo $ING_SRC/gateway/*/$ING_VERS`
    else
	gwdirs="$ING_SRC/gateway"
    fi
    msgclause="and gateway "
else
    gwdirs=""
    msgclause=" "
fi

echo "Finding front-end ${msgclause}msg files..."
find /dev/null -follow -print >/dev/null 2>&1 && follow=-follow
export follow
plusone=+1
sort +1 /dev/null >/dev/null 2>&1 || plusone='-k 2'
export plusone

if [ "$ING_VERS" ]
then
    MSGFILES=`(
	for dir in $ING_SRC/front/*/$ING_VERS $gwdirs ; \
	do \
	    cd $dir ; \
	    find * $follow -name '*.msg' -print | \
	    sed -e "s:^:${dir}/:" ; \
	done \
	) | \
           sed -e "s:^$ING_SRC/::" -e "s:[^/]*.msg:	&:" | \
	   sort -u -t'	' $plusone | sed "s:	::"`
else
    MSGFILES=`find $ING_SRC/front $gwdirs $follow -name '*.msg' -print | \
           grep "/$V" | \
           sed -e "s:^$ING_SRC/::" -e "s:[^/]*.msg:	&:" | \
           sort -u -t'	' $plusone | sed "s:	::"`
fi

# Build $catfile
echo "Building fe.cat.msg..."
rm -f $catfile
for file in $MSGFILES
 {
   msgfile=`echo $file | sed "s:^:$ING_SRC/:"`
   cat $msgfile >> $catfile
 }

echo "$CMD: done: `date`"
exit 0
