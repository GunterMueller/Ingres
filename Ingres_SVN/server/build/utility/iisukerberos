#!/bin/bash
#
#  Copyright (c) 2006 Ingres Corporation
#
#  Name: iisukerberos -- setup script for Ingres Kerberos Driver
#  Usage:
#	iisukerberos
#
#  Description:
#	This script should only be called by the Ingres installation
#	utility.  It sets up the Ingres Kerberos Driver.
#
#  Exit Status:
#	0	setup procedure completed.
#	1	setup procedure did not complete.
#
#  PROGRAM = iisukerberos
#
#  DEST = utility
#----------------------------------------------------------------------------

BATCH=false
NOTBATCH=true
INSTLOG="2>&1 | tee -a $II_SYSTEM/ingres/files/install.log"
WRITE_RESPONSE=false
READ_RESPONSE=false
IGNORE_RESPONSE="true"
export IGNORE_RESPONSE
optional_config()
{
NOT_DONE=true
while $NOT_DONE; do
cat << !
Basic Kerberos Configuration Options

1.  Client Kerberos configuration
2.  Name Server Kerberos authentication
3.  Standard Kerberos authentication configuration (both 1 and 2)
0.  Exit

!
iiechonn "Select from [0 - 3] above [0]: "
read ENTRY junk
[ "$ENTRY" == "" ] && ENTRY=0
case $ENTRY in
    1)
        cat << !

Client configuration enables this installation to use Kerberos to authenticate 
against a remote installation that has been configured to use Kerberos for 
authentication.  This is the mimimum level of Kerberos authentication.

!
        PROMPTING=true
        while $PROMPTING; do
echo "Select 'a' to add client-level Kerberos authentication,"
iiechonn "select 'r' to remove client-level Kerberos authentication: "
        read ADDorREM junk
        ADDorREM=`echo $ADDorREM | tr '[A-Z]' '[a-z]' `
        case $ADDorREM in
        a)
             iisetres ii.$CONFIG_HOST.gcf.mechanisms "kerberos"
            cat << !

Client Kerberos configuration added.

You must add the "authentication_mechanism" attribute in netutil for 
each remote node you wish to authenticate using Kerberos.  The 
"authentication_mechanism" attribute must be set to "kerberos".  There 
is no need to define users or passwords for vnodes using Kerberos 
authentication.

!
            PROMPTING=false
            pause
            ;;
        r)
            iisetres ii.$CONFIG_HOST.gcf.mechanisms ""
            echo "Client Kerberos configuration removed"
            echo ""
            PROMPTING=false
            pause
            ;;
        *)
            echo "Entry must be 'a' or 'r'"
            pause
            ;;
        esac
        done
        ;;
    2)
        cat << !

Name Server Kerberos authentication allows the local Name Server to 
authenticate using Kerberos.

!
        PROMPTING=true
        while $PROMPTING; do
echo "Select 'a' to add Kerberos authentication for the local Name Server,"
iiechonn "select 'r' to remove Name Server Kerberos authentication: "

        read ADDorREM junk
        ADDorREM=`echo $ADDorREM | tr '[A-Z]' '[a-z]' `
        case $ADDorREM in
        a)
            iisetres ii.$CONFIG_HOST.gcn.mechanisms "kerberos"
            iisetres ii.$CONFIG_HOST.gcn.remote_mechanism "kerberos"
            echo ""
            echo "Kerberos authentication has been added to the Name Server on $FULL_HOSTNAME"
            echo ""
            PROMPTING=false
            pause
            ;;
        r)
            iisetres ii.$CONFIG_HOST.gcn.mechanisms ""
            iisetres ii.$CONFIG_HOST.gcn.remote_mechanism "none"
            echo ""
            echo "Kerberos authentication has been removed from the Name Server on $FULL_HOSTNAME"
            echo ""
            PROMPTING=false
            pause
            ;;
        *)
            echo "Entry must be 'a' or 'r'"
            pause
            ;;
        esac
        done
        ;;
    3)
        cat << !

Standard Kerberos authentication specifies Kerberos as the remote 
authentication mechanism for the Name Server, and allows clients to specify 
Kerberos for remote servers that authenticate with Kerberos.

!
        PROMPTING=true
        while $PROMPTING; do
echo "Select 'a' to add standard Kerberos authentication,"
iiechonn "select 'r' to remove standard Kerberos authentication: "

        read ADDorREM junk
        ADDorREM=`echo $ADDorREM | tr '[A-Z]' '[a-z]' `
        case $ADDorREM in
        a)
             iisetres ii.$CONFIG_HOST.gcf.mechanisms "kerberos"
            iisetres ii.$CONFIG_HOST.gcn.mechanisms "kerberos"
            iisetres ii.$CONFIG_HOST.gcn.remote_mechanism "kerberos"
            echo ""
            echo "Standard Kerberos authentcation added." 
            cat << !

You must add the "authentication_mechanism" attribute in netutil for
each remote node you wish to authenticate using Kerberos.  The
"authentication_mechanism" attribute must be set to "kerberos".  There
is no need to define users or passwords for vnodes using Kerberos
authentication.

!
            PROMPTING=false
            pause
            ;;
        r)
            iisetres ii.$CONFIG_HOST.gcf.mechanisms ""
            iisetres ii.$CONFIG_HOST.gcn.mechanisms ""
            iisetres ii.$CONFIG_HOST.gcn.remote_mechanism "none"
            echo ""
	    echo "Standard Kerberos authentcation removed." 
            echo ""
            PROMPTING=false
            pause
            ;;
        *)
            echo "Entry must be 'a' or 'r'"
            pause
            ;;
        esac
        done
        ;;
    0)
        cat << !

Kerberos configuration complete.  Be sure the GSS API library, libgssapi.$SLSFX,
resides in your library path, as defined by the environment variable
LD_LIBRARY_PATH or LIBPATH.
 
You may use the cbf utility to fine-tune Kerberos security options.

!
        NOT_DONE=false
        ;;
    *)  echo "Entry must be in range 0 to 3"
        pause
esac
done
trap : 0
clean_exit
}
# check for batch flag
if [ "$1" = "-batch" ] ; then
   BATCH=true
   NOTBATCH=false
   INSTLOG="2>&1 | cat >> $II_SYSTEM/ingres/files/install.log"
   shift ;
elif [ "$1" = "-vbatch" ] ; then
   BATCH=true
   NOTBATCH=false
   shift;
fi

export WRITE_RESPONSE
export READ_RESPONSE
FULL_HOSTNAME=`iinethost`

trap "rm -f $II_SYSTEM/ingres/files/config.lck /tmp/*.$$ 1>/dev/null \
2>/dev/null; exit 1" 0 1 2 3 15

if [ "$1" = "-rmpkg" ] ; then

   II_CONF_DIR=$II_SYSTEM/ingres/files
 
   cp -p $II_CONF_DIR/config.dat $II_CONF_DIR/config.tmp
 
   trap "cp -p $II_CONF_DIR/config.tmp $II_CONF_DIR/config.dat; \
         rm -f $II_CONF_DIR/config.tmp; exit 1" 1 2 3 15
 
   cat $II_CONF_DIR/config.dat | grep -v 'gcf\.mech\.kerberos' \
       | grep -v 'kerberos_driver' > $II_CONF_DIR/config.new
 
   rm -f $II_CONF_DIR/config.dat
 
   mv $II_CONF_DIR/config.new $II_CONF_DIR/config.dat
 
   rm -f $II_CONF_DIR/config.tmp

   cat << !
  Ingres Kerberos Driver has been removed.

!
else

. iisysdep

. iishlib

do_iisukerberos()
{

echo "Setting up the Ingres Kerberos Driver..."


iisulock "Ingres Kerberos Driver setup" || exit 1

if [ -f $II_SYSTEM/ingres/install/release.dat ]; then
   VERSION=`$II_SYSTEM/ingres/install/ingbuild -version` ||
   {
       cat << !

$VERSION

!
      exit 1
   }
else
   VERSION=`head -1 $II_SYSTEM/ingres/version.rel` ||
   {
       cat << !

Missing file $II_SYSTEM/ingres/version.rel

!
      exit 1
   }
fi


RELEASE_ID=`echo $VERSION | sed "s/[ ().\/]//g"`

SETUP=`iigetres ii.$CONFIG_HOST.config.kerberos_driver.$RELEASE_ID` || exit 1

cat << !

This procedure will set up the following version of Ingres Kerberos driver:

        $VERSION

to run on local host:

        $FULL_HOSTNAME

!

prompt "Do you want to continue this setup procedure?" y  || exit 1

# Generate default configuration resources in case "iisukerberos -rmpkg" 
# was invoked previously.
echo ""
echo "Generating default configuration..."

      if iigenres $CONFIG_HOST $II_SYSTEM/ingres/files/net.rfm 
      then
         echo "Default configuration generated."
      else
         cat << !
An error occurred while generating the default configuration.

!
         exit 1
      fi

eval optional_config $INSTLOG
pause
}

if $BATCH
then
# Batch mode currently does nothing since the default Kerberos configuration
# is handled in all.crs, thus any script that executes iigenres adds Kerberos
# in the same manner as the other security mechanisms.
   exit 0
else
   eval do_iisukerberos $INSTLOG
   trap : 0
   exit 0
fi
fi
